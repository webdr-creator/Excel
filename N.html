<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محرر وعارض ملف Excel</title>
    <!-- إضافة مكتبة SheetJS لقراءة ملفات Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .description {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .auth-section {
            background-color: var(--light-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, textarea, button, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            margin: 5px 0;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .editor-section {
            display: none;
            margin-top: 30px;
        }
        
        .file-info {
            background-color: var(--light-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .excel-viewer {
            margin-top: 20px;
            overflow: auto;
            max-height: 600px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .sheet-tabs {
            display: flex;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
        }
        
        .sheet-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-right: 1px solid #ddd;
            white-space: nowrap;
        }
        
        .sheet-tab.active {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .excel-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            position: sticky;
            top: 0;
        }
        
        .excel-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
            min-width: 100px;
        }
        
        .excel-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .excel-table tr:hover {
            background-color: #e3f2fd;
        }
        
        .editor-toolbar {
            background-color: #f8f9fa;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .view-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .editor-toolbar {
                flex-direction: column;
            }
            
            .view-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>عارض ومحرر ملف Excel على GitHub</h1>
            <p class="description">هذه الأداة تسمح لك بعرض وتعديل ملف Excel الموجود في مستودع GitHub الخاص بك</p>
        </header>
        
        <section class="auth-section">
            <h2>معلومات المصادقة</h2>
            <p>لعرض وتعديل الملف، تحتاج إلى توفير رمز الوصول الشخصي (Personal Access Token) من GitHub</p>
            
            <div class="form-group">
                <label for="github-token">رمز الوصول الشخصي (GitHub Personal Access Token)</label>
                <input type="password" id="github-token" placeholder="أدخل رمز الوصول الشخصي">
                <small>يجب أن يحتوي الرمز على أذونات repo للوصول الكامل إلى المستودعات</small>
            </div>
            
            <div class="form-group">
                <label for="repo-owner">مالك المستودع (Repository Owner)</label>
                <input type="text" id="repo-owner" value="webdr-creator" placeholder="اسم المستخدم أو المنظمة">
            </div>
            
            <div class="form-group">
                <label for="repo-name">اسم المستودع (Repository Name)</label>
                <input type="text" id="repo-name" value="webdr-creator.github.io" placeholder="اسم المستودع">
            </div>
            
            <div class="form-group">
                <label for="file-path">مسار الملف داخل المستودع</label>
                <input type="text" id="file-path" value="Excel/MCQD.XLSX" placeholder="مسار الملف">
            </div>
            
            <button id="load-file-btn">تحميل وعرض الملف</button>
        </section>
        
        <div class="loading" id="loading-indicator">
            <div class="spinner"></div>
            <p>جاري تحميل وعرض البيانات...</p>
        </div>
        
        <section class="editor-section" id="editor-section">
            <div class="file-info">
                <h3>معلومات الملف</h3>
                <p id="file-info-text"></p>
            </div>
            
            <div class="view-options">
                <label for="sheet-select">اختر الورقة:</label>
                <select id="sheet-select"></select>
                
                <button id="download-btn">تحميل الملف الأصلي</button>
                <button id="export-json-btn">تصدير كـ JSON</button>
                <button id="export-csv-btn">تصدير كـ CSV</button>
            </div>
            
            <div class="editor-toolbar">
                <button id="save-btn">حفظ التغييرات على GitHub</button>
                <button id="add-row-btn">إضافة صف</button>
                <button id="add-col-btn">إضافة عمود</button>
                <button id="reset-btn">إعادة تعيين</button>
            </div>
            
            <div class="excel-viewer" id="excel-viewer">
                <!-- سيتم عرض جدول Excel هنا -->
            </div>
            
            <div class="status-message" id="status-message"></div>
        </section>
    </div>

    <script>
        // عناصر DOM
        const githubTokenInput = document.getElementById('github-token');
        const repoOwnerInput = document.getElementById('repo-owner');
        const repoNameInput = document.getElementById('repo-name');
        const filePathInput = document.getElementById('file-path');
        const loadFileBtn = document.getElementById('load-file-btn');
        const editorSection = document.getElementById('editor-section');
        const saveBtn = document.getElementById('save-btn');
        const downloadBtn = document.getElementById('download-btn');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const addRowBtn = document.getElementById('add-row-btn');
        const addColBtn = document.getElementById('add-col-btn');
        const resetBtn = document.getElementById('reset-btn');
        const sheetSelect = document.getElementById('sheet-select');
        const statusMessage = document.getElementById('status-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const fileInfoText = document.getElementById('file-info-text');
        const excelViewer = document.getElementById('excel-viewer');
        
        // متغيرات التطبيق
        let originalWorkbook = null;
        let currentWorkbook = null;
        let fileSha = '';
        let currentSheetName = '';
        
        // حدث تحميل الملف
        loadFileBtn.addEventListener('click', async () => {
            const token = githubTokenInput.value.trim();
            const owner = repoOwnerInput.value.trim();
            const repo = repoNameInput.value.trim();
            const path = filePathInput.value.trim();
            
            if (!token || !owner || !repo || !path) {
                showStatus('يرجى ملء جميع الحقول', 'error');
                return;
            }
            
            try {
                loadingIndicator.style.display = 'block';
                loadFileBtn.disabled = true;
                
                // جلب الملف من GitHub
                const fileData = await getFileFromGitHub(token, owner, repo, path);
                
                if (fileData) {
                    fileSha = fileData.sha;
                    
                    // تحويل محتوى Base64 إلى ArrayBuffer
                    const content = base64ToArrayBuffer(fileData.content);
                    
                    // قراءة ملف Excel باستخدام SheetJS
                    const workbook = XLSX.read(content, { type: 'array' });
                    
                    // حفظ النسخة الأصلية والحالية
                    originalWorkbook = workbook;
                    currentWorkbook = XLSX.utils.book_copy(workbook);
                    
                    // عرض معلومات الملف
                    fileInfoText.textContent = `الملف: ${path} | الحجم: ${formatFileSize(content.byteLength)} | عدد الأوراق: ${workbook.SheetNames.length}`;
                    
                    // تعبئة قائمة الأوراق
                    populateSheetSelect(workbook.SheetNames);
                    
                    // عرض الورقة الأولى
                    displaySheet(workbook.SheetNames[0]);
                    
                    // إظهار قسم المحرر
                    editorSection.style.display = 'block';
                    
                    showStatus('تم تحميل وعرض الملف بنجاح', 'success');
                }
            } catch (error) {
                console.error('Error loading file:', error);
                showStatus(`خطأ في تحميل الملف: ${error.message}`, 'error');
            } finally {
                loadingIndicator.style.display = 'none';
                loadFileBtn.disabled = false;
            }
        });
        
        // حدث تغيير الورقة
        sheetSelect.addEventListener('change', () => {
            const selectedSheet = sheetSelect.value;
            if (selectedSheet) {
                displaySheet(selectedSheet);
            }
        });
        
        // حدث حفظ التغييرات
        saveBtn.addEventListener('click', async () => {
            const token = githubTokenInput.value.trim();
            const owner = repoOwnerInput.value.trim();
            const repo = repoNameInput.value.trim();
            const path = filePathInput.value.trim();
            
            if (!token || !owner || !repo || !path) {
                showStatus('يرجى ملء جميع الحقول', 'error');
                return;
            }
            
            try {
                loadingIndicator.style.display = 'block';
                saveBtn.disabled = true;
                
                // تحويل Workbook إلى ArrayBuffer
                const arrayBuffer = XLSX.write(currentWorkbook, { bookType: 'xlsx', type: 'array' });
                
                // تحويل ArrayBuffer إلى Base64
                const base64Content = arrayBufferToBase64(arrayBuffer);
                
                // تحديث الملف على GitHub
                const result = await updateFileOnGitHub(token, owner, repo, path, base64Content, fileSha);
                
                if (result) {
                    fileSha = result.content.sha;
                    originalWorkbook = XLSX.utils.book_copy(currentWorkbook);
                    showStatus('تم حفظ التغييرات بنجاح على GitHub', 'success');
                }
            } catch (error) {
                console.error('Error saving file:', error);
                showStatus(`خطأ في حفظ الملف: ${error.message}`, 'error');
            } finally {
                loadingIndicator.style.display = 'none';
                saveBtn.disabled = false;
            }
        });
        
        // حدث تحميل الملف الأصلي
        downloadBtn.addEventListener('click', () => {
            if (!currentWorkbook) return;
            
            XLSX.writeFile(currentWorkbook, filePathInput.value.split('/').pop() || 'file.xlsx');
            showStatus('تم بدء تحميل الملف', 'success');
        });
        
        // حدث تصدير كـ JSON
        exportJsonBtn.addEventListener('click', () => {
            if (!currentWorkbook || !currentSheetName) return;
            
            const worksheet = currentWorkbook.Sheets[currentSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            downloadBlob(blob, `${currentSheetName}.json`);
            showStatus('تم تصدير البيانات كـ JSON', 'success');
        });
        
        // حدث تصدير كـ CSV
        exportCsvBtn.addEventListener('click', () => {
            if (!currentWorkbook || !currentSheetName) return;
            
            const worksheet = currentWorkbook.Sheets[currentSheetName];
            const csvData = XLSX.utils.sheet_to_csv(worksheet);
            
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            downloadBlob(blob, `${currentSheetName}.csv`);
            showStatus('تم تصدير البيانات كـ CSV', 'success');
        });
        
        // حدث إضافة صف
        addRowBtn.addEventListener('click', () => {
            if (!currentWorkbook || !currentSheetName) return;
            
            const worksheet = currentWorkbook.Sheets[currentSheetName];
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            range.e.r += 1; // زيادة عدد الصفوف
            
            // إضافة خلية فارغة في آخر صف
            const newRow = range.e.r;
            const cols = range.e.c;
            
            for (let c = 0; c <= cols; c++) {
                const cellAddress = XLSX.utils.encode_cell({ r: newRow, c: c });
                if (!worksheet[cellAddress]) {
                    worksheet[cellAddress] = { v: '', t: 's' };
                }
            }
            
            worksheet['!ref'] = XLSX.utils.encode_range(range);
            displaySheet(currentSheetName);
            showStatus('تم إضافة صف جديد', 'success');
        });
        
        // حدث إضافة عمود
        addColBtn.addEventListener('click', () => {
            if (!currentWorkbook || !currentSheetName) return;
            
            const worksheet = currentWorkbook.Sheets[currentSheetName];
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            range.e.c += 1; // زيادة عدد الأعمدة
            
            // إضافة خلية فارغة في آخر عمود
            const newCol = range.e.c;
            const rows = range.e.r;
            
            for (let r = 0; r <= rows; r++) {
                const cellAddress = XLSX.utils.encode_cell({ r: r, c: newCol });
                if (!worksheet[cellAddress]) {
                    worksheet[cellAddress] = { v: '', t: 's' };
                }
            }
            
            worksheet['!ref'] = XLSX.utils.encode_range(range);
            displaySheet(currentSheetName);
            showStatus('تم إضافة عمود جديد', 'success');
        });
        
        // حدث إعادة تعيين
        resetBtn.addEventListener('click', () => {
            if (confirm('هل تريد حقًا إعادة تعيين جميع التغييرات؟')) {
                currentWorkbook = XLSX.utils.book_copy(originalWorkbook);
                displaySheet(currentSheetName);
                showStatus('تم إعادة تعيين جميع التغييرات', 'success');
            }
        });
        
        // دالة لعرض ورقة Excel
        function displaySheet(sheetName) {
            if (!currentWorkbook) return;
            
            currentSheetName = sheetName;
            const worksheet = currentWorkbook.Sheets[sheetName];
            const htmlString = XLSX.utils.sheet_to_html(worksheet, { editable: true });
            
            excelViewer.innerHTML = htmlString;
            
            // جعل الخلايا قابلة للتعديل
            makeCellsEditable();
        }
        
        // دالة لجعل الخلايا قابلة للتعديل
        function makeCellsEditable() {
            const cells = excelViewer.querySelectorAll('td');
            cells.forEach(cell => {
                cell.setAttribute('contenteditable', 'true');
                
                cell.addEventListener('blur', function() {
                    updateWorkbookFromTable(this);
                });
            });
        }
        
        // دالة لتحديث Workbook من الجدول
        function updateWorkbookFromTable(cell) {
            if (!currentWorkbook || !currentSheetName) return;
            
            const worksheet = currentWorkbook.Sheets[currentSheetName];
            const table = excelViewer.querySelector('table');
            const rows = table.rows;
            
            for (let r = 0; r < rows.length; r++) {
                for (let c = 0; c < rows[r].cells.length; c++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: r, c: c });
                    const cellValue = rows[r].cells[c].textContent;
                    
                    if (!worksheet[cellAddress]) {
                        worksheet[cellAddress] = { t: 's', v: cellValue };
                    } else {
                        worksheet[cellAddress].v = cellValue;
                    }
                }
            }
        }
        
        // دالة لتعبيئة قائمة الأوراق
        function populateSheetSelect(sheetNames) {
            sheetSelect.innerHTML = '';
            sheetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                sheetSelect.appendChild(option);
            });
        }
        
        // الدوال المساعدة
        async function getFileFromGitHub(token, owner, repo, path) {
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`فشل في جلب الملف: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        async function updateFileOnGitHub(token, owner, repo, path, content, sha) {
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `تحديث ${path}`,
                    content: content,
                    sha: sha
                })
            });
            
            if (!response.ok) {
                throw new Error(`فشل في تحديث الملف: ${response.status} ${response.statusText}`);
            }
            
            return await response.json();
        }
        
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64.replace(/\s/g, ''));
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }
        
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
