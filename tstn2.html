<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>WAY</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
  /* --- احتفظت بكل الأنماط الأصلية ثم أضفت أنماط الزر الجديد --- */
  body { font-size: 16px; background: #e0e0e0; color: #333; min-height: 100vh; padding: 20px; display: flex; flex-direction: column; align-items: center; }
  .container { width: 100%; max-width: 900px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; margin: 20px 0; position: relative; }
  header { background: #2e7d52; color: white; padding: 18px 10px 18px 10px; text-align: center; }
  h1 { font-size: 27px; margin-bottom: 3px; font-weight: bold;}
  /* ... (باقي الأنماط كما كانت) ... */
  .navigation-bar-fixed-top { display:flex; justify-content:center; align-items:center; gap:7px; background:#fff; z-index:30; padding:7px 0 7px 0; margin:0 -12px 10px -12px; border-bottom:1px solid #e0e0e0; }
  .nav-btn { padding:5px 13px; background:#2e7d52; color:white; border:none; border-radius:7px; cursor:pointer; font-size:12px; transition:all .3s; min-width:54px; }
  .nav-btn:disabled { background:#cccccc; cursor:not-allowed; }
  .show-featured-btn { padding:2px 10px; background:#fffbe6; color:#d58500; border:1px solid #ffb300; border-radius:7px; font-size:11px; cursor:pointer; }
  .home-btn { background:none; border:none; font-size:1.6rem; cursor:pointer; padding:2px 8px; color:#2e7d52; transition:background .2s; line-height:1; }
  .home-btn:hover { background:#e3f2fd; border-radius:50%; }

  /* زر وضع الدراسة (صحين) */
  .study-toggle {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 6px 10px;
    border-radius: 7px;
    color: #9e9e9e; /* فضي عند الإيقاف */
    transition: color .18s, background .18s, transform .12s;
  }
  .study-toggle:hover { background: #f1f1f1; }
  .study-toggle.on {
    color: #2e7d52; /* لون أيقونة أخضر غامق - يتوافق مع بقية الألوان */
    filter: drop-shadow(0 2px 6px rgba(46,125,82,0.18));
    transform: translateY(-2px);
  }

  /* بقية الأنماط (مختصرة هنا للحجم) */
  .question-container { margin-bottom:18px; padding:13px; border:2px solid #ddd; border-radius:8px; background:#f9f9f9; min-height:110px; position:relative; }
  .question-header-bar { display:flex; align-items:center; gap:9px; margin-bottom:7px; width:100%; }
  .star-btn { background:none; border:none; font-size:23px; color:#ccc; cursor:pointer; }
  .star-btn.starred { color:#ffc107 !important; }
  .options-container { display:flex; flex-direction:column; gap:8px; min-height:120px; margin-bottom:5px; }
  .option { padding:9px; background:#f8f8f8; border:2px solid #e0e0e0; border-radius:7px; cursor:pointer; transition:all .2s; font-size:13px; }
  .option:hover { border-color:#2e7d52; background:#f0f8f1; }
  .correct { border-color:#4caf50 !important; border-width:4px !important; color:#2c3e50; background:#f9f9f9 !important; }
  .incorrect { border-color:#f44336 !important; border-width:4px !important; color:#2c3e50; background:#f9f9f9 !important; }
  .shake { animation: shake 0.5s; }
  @keyframes shake { 0%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(10px)}60%{transform:translateX(-10px)}80%{transform:translateX(10px)}100%{transform:translateX(0)} }
  /* ... (أنماط إضافية إن لزم) ... */
</style>
</head>
<body>
<audio id="click-audio" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12bfa6f1e1.mp3"></audio>
<div class="container">
  <header><h1>WAY</h1></header>

  <div class="loading" id="loading">
    <i class="fas fa-spinner fa-spin"></i> جاري تحميل بيانات الاختبار...
  </div>

  <div class="subject-selection" id="subject-section" style="display:none;">
    <h2>اختر المادة:</h2>
    <div class="selection-container">
      <select id="subject-select"></select>
      <select id="column10-info"></select>
      <select id="column11-select" style="display:none"></select>
    </div>
    <button class="start-btn" id="start-btn">بدء الاختبار</button>
  </div>

  <div class="exam-section" id="exam-section">
    <div class="subject-name" id="subject-name"></div>
    <div class="progress-text">السؤال <span id="current-q">1</span> من <span id="total-qs">0</span></div>

    <div class="progress-slider-bar">
      <div class="slider-labels left"><span>1</span></div>
      <input class="slider" id="question-slider" max="10" min="1" type="range" value="10"/>
      <div class="slider-labels right"><span id="max-question">10</span></div>
    </div>

    <div class="navigation-bar-fixed-top" id="nav-top-bar">
      <button class="nav-btn" disabled id="prev-btn">السابق</button>
      <button class="nav-btn" id="next-btn">التالي</button>
      <button class="show-featured-btn" id="show-featured-btn" title="عرض المميزة"><i class="fa-regular fa-star"></i> عرض المميزة</button>

      <!-- زر الصفحة الرئيسية -->
      <button class="home-btn" id="nav-home-btn" title="الصفحة الرئيسية"><i class="fas fa-home"></i></button>

      <!-- زر وضع الدراسة: الصحين -->
      <button class="study-toggle" id="study-toggle" title="وضع الدراسة: إظهار الإجابات الصحيحة">
        <i class="fa-solid fa-check-double"></i>
      </button>
    </div>

    <div class="question-container" id="question-container">
      <div class="question-header-bar">
        <button class="star-btn" id="star-btn" title="تمييز السؤال"><i class="fa-regular fa-star"></i></button>
        <div class="question-text" id="question-text"></div>
      </div>

      <div class="options-container" id="options-container"></div>
      <div class="question-explanation" id="question-explanation" style="display:none;"></div>
      <button class="info-btn" id="info-btn" title="عرض الشرح"><i class="fa-solid fa-circle-info"></i></button>
      <button class="info-btn" id="show-answer-btn" title="إظهار الإجابة الصحيحة"><i class="fa-solid fa-check"></i></button>
    </div>

    <button class="bottom-back-btn" id="bottom-back-btn" style="display:none">
      <i class="fas fa-home"></i> العودة للبداية
    </button>
  </div>

  <div class="results-section" id="results-section" style="display:none;">
    <h2>لقد أكملت الاختبار!</h2>
    <p>درجتك النهائية هي:</p>
    <div class="score" id="score">0/0</div>
    <button class="restart-btn" id="restart-btn">إعادة الاختبار</button>
    <button class="bottom-back-btn" id="results-back-btn">
      <i class="fas fa-home"></i> العودة للبداية
    </button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  /* --- عناصر DOM --- */
  const loadingElement = document.getElementById('loading');
  const subjectSection = document.getElementById('subject-section');
  const subjectSelect = document.getElementById('subject-select');
  const column10Info = document.getElementById('column10-info');
  const startBtn = document.getElementById('start-btn');
  const examSection = document.getElementById('exam-section');
  const subjectNameElement = document.getElementById('subject-name');
  const resultsSection = document.getElementById('results-section');
  const questionText = document.getElementById('question-text');
  const optionsContainer = document.getElementById('options-container');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const currentQ = document.getElementById('current-q');
  const totalQs = document.getElementById('total-qs');
  const scoreElement = document.getElementById('score');
  const restartBtn = document.getElementById('restart-btn');
  const bottomBackBtn = document.getElementById('bottom-back-btn');
  const resultsBackBtn = document.getElementById('results-back-btn');
  const questionSlider = document.getElementById('question-slider');
  const maxQuestionLabel = document.getElementById('max-question');
  const starBtn = document.getElementById('star-btn');
  const showFeaturedBtn = document.getElementById('show-featured-btn');
  const navHomeBtn = document.getElementById('nav-home-btn');
  const questionContainer = document.getElementById('question-container');
  const clickAudio = document.getElementById('click-audio');
  const studyToggle = document.getElementById('study-toggle');

  /* --- بيانات التطبيق --- */
  let questionsData = [];
  let currentSubject = '';
  let currentQuestions = [];
  let currentQuestionIndex = 0;
  let userAnswers = [];
  let starredQuestions = [];
  let subjectColumn10 = {};
  let subjectColumn11 = {};
  let showOnlyStarred = false;
  let studyMode = false; // <-- متغير وضع الدراسة (الزر الجديد)
  const excelFileURL = "https://webdr-creator.github.io/Excel/MCQ2.xlsx";

  function getStarStorageKey(subject) { return `starredQuestions_${subject}`; }
  function loadStarredQuestions(subject) {
    try { const saved = localStorage.getItem(getStarStorageKey(subject)); starredQuestions = saved ? JSON.parse(saved) : []; }
    catch (e) { starredQuestions = []; }
  }
  function saveStarredQuestions(subject) { localStorage.setItem(getStarStorageKey(subject), JSON.stringify(starredQuestions)); }

  loadExcelFile(excelFileURL);
  function loadExcelFile(url) {
    loadingElement.style.display = 'block';
    fetch(url).then(response => {
      if (!response.ok) throw new Error('حدث خطأ في تحميل الملف');
      return response.arrayBuffer();
    }).then(data => {
      processExcelData(data);
      loadingElement.style.display = 'none';
      subjectSection.style.display = 'block';
    }).catch(error => {
      console.error('Error:', error);
      loadingElement.innerHTML = '<p style="color:red;">فشل في تحميل ملف Excel. يرجى التحقق من الاتصال بالإنترنت.</p>';
    });
  }

  function processExcelData(data) {
    const workbook = XLSX.read(data, { type: 'array' });
    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
    questionsData = [];
    const subjects = new Set();
    subjectColumn10 = {};
    const startRow = jsonData[0].length > 0 && isNaN(jsonData[0][0]) ? 1 : 0;
    for (let i = startRow; i < jsonData.length; i++) {
      const row = jsonData[i];
      if (!row || row.length < 7) continue;
      const question = {
        explanation: row[7] || '',
        text: row[0] || 'بدون نص',
        options: [],
        correctAnswer: parseInt(row[6]) || 1,
        subject: row[8] || 'عام',
        id: i,
        col10: row[9] || '',
        col11: row[10] || ''
      };
      for (let j = 1; j <= 5; j++) if (row[j]) question.options.push(row[j]);
      if (question.options.length === 0) { question.options.push('نعم'); question.options.push('لا'); }
      questionsData.push(question);
      subjects.add(question.subject);
      if (row[9] && !subjectColumn10[question.subject]) subjectColumn10[question.subject] = row[9];
    }
    subjectSelect.innerHTML = '';
    subjects.forEach(subject => { const option = document.createElement('option'); option.value = subject; option.textContent = subject; subjectSelect.appendChild(option); });
    currentSubject = subjectSelect.value;
    updateColumn10Info();
    loadStarredQuestions(currentSubject);
  }

  function updateColumn10Info() {
    const info = subjectColumn10[currentSubject] || 'لا توجد معلومات إضافية';
    column10Info.innerHTML = '';
    let col10Set = new Set();
    questionsData.forEach(q => { if (q.subject === currentSubject && q.col10) col10Set.add(q.col10); });
    col10Set.forEach(val => { const opt = document.createElement('option'); opt.value = val; opt.textContent = val; column10Info.appendChild(opt); });

    const column11Select = document.getElementById('column11-select');
    column11Select.innerHTML = '';
    let firstCol10 = column10Info.value;
    let col11Set = new Set();
    questionsData.forEach(q => { if (q.subject === currentSubject && q.col10 === firstCol10 && q.col11) col11Set.add(q.col11); });
    if (col11Set.size > 0) {
      column11Select.style.display = 'inline-block';
      const allOpt = document.createElement('option'); allOpt.value = 'الكل'; allOpt.textContent = 'الكل'; column11Select.appendChild(allOpt);
      col11Set.forEach(val => { const opt = document.createElement('option'); opt.value = val; opt.textContent = val; column11Select.appendChild(opt); });
    } else { column11Select.style.display = 'none'; }

    column10Info.addEventListener('change', function() {
      column11Select.innerHTML = '';
      let col11Set2 = new Set();
      questionsData.forEach(q => { if (q.subject === currentSubject && q.col10 === this.value && q.col11) col11Set2.add(q.col11); });
      if (col11Set2.size > 0) {
        column11Select.style.display = 'inline-block';
        const allOpt = document.createElement('option'); allOpt.value = 'الكل'; allOpt.textContent = 'الكل'; column11Select.appendChild(allOpt);
        col11Set2.forEach(val => { const opt = document.createElement('option'); opt.value = val; opt.textContent = val; column11Select.appendChild(opt); });
      } else { column11Select.style.display = 'none'; }
    });

    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "اختر فصل";
    placeholder.disabled = true;
    placeholder.selected = true;
    column10Info.appendChild(placeholder);

    const opt = document.createElement('option');
    opt.value = info;
    opt.textContent = info;
    column10Info.appendChild(opt);
  }

  subjectSelect.addEventListener('change', function() {
    currentSubject = this.value;
    updateColumn10Info();
    loadStarredQuestions(currentSubject);
    if (examSection.style.display === 'block') updateStarButton();
  });

  startBtn.addEventListener('click', function() {
    currentSubject = subjectSelect.value;
    let col10Val = document.getElementById('column10-info').value;
    let col11Val = document.getElementById('column11-select').value;
    currentQuestions = questionsData.filter(q => q.subject === currentSubject);
    if (col10Val) currentQuestions = currentQuestions.filter(q => q.col10 === col10Val);
    if (col11Val && col11Val !== 'الكل') currentQuestions = currentQuestions.filter(q => q.col11 === col11Val);
    if (currentQuestions.length === 0) { alert('لا توجد أسئلة لهذه المادة'); return; }
    userAnswers = new Array(currentQuestions.length).fill(null);
    loadStarredQuestions(currentSubject);
    currentQuestionIndex = 0;
    showOnlyStarred = false;
    showFeaturedBtn.classList.remove('active');
    showFeaturedBtn.innerHTML = '<i class="fa-regular fa-star"></i> عرض المميزة';
    totalQs.textContent = currentQuestions.length;
    subjectNameElement.textContent = currentSubject;
    maxQuestionLabel.textContent = currentQuestions.length;
    questionSlider.max = currentQuestions.length;
    questionSlider.value = currentQuestions.length;
    updateProgressAndSlider();
    updateStarButton();
    showQuestion();
    subjectSection.style.display = 'none';
    examSection.style.display = 'block';
  });

  function getDisplayedQuestions() {
    if (showOnlyStarred) return currentQuestions.filter(q => starredQuestions.includes(q.id));
    return currentQuestions;
  }

  showFeaturedBtn.addEventListener('click', function() {
    showOnlyStarred = !showOnlyStarred;
    this.classList.toggle('active', showOnlyStarred);
    this.innerHTML = showOnlyStarred ? '<i class="fa-regular fa-star"></i> عرض الكل' : '<i class="fa-regular fa-star"></i> عرض المميزة';
    const displayed = getDisplayedQuestions();
    if (displayed.length === 0) {
      questionText.innerHTML = '<p>لا توجد أسئلة مميزة بعد.</p>';
      optionsContainer.innerHTML = '';
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      currentQ.textContent = 0;
      totalQs.textContent = 0;
      questionSlider.max = 1;
      questionSlider.value = currentQuestions.length;
      updateProgressAndSlider();
    } else {
      currentQuestionIndex = 0;
      showQuestion();
      updateProgressAndSlider();
      updateNavigationButtons();
    }
  });

  navHomeBtn.addEventListener('click', function() {
    subjectSection.style.display = 'block';
    examSection.style.display = 'none';
    resultsSection.style.display = 'none';
  });

  function updateStarButton() {
    const displayedQuestions = getDisplayedQuestions();
    if (displayedQuestions.length === 0) return;
    const question = displayedQuestions[currentQuestionIndex];
    const isStarred = starredQuestions.includes(question.id);
    const starIcon = starBtn.querySelector('i');
    if (isStarred) { starBtn.classList.add('starred'); starIcon.classList.remove('fa-regular'); starIcon.classList.add('fa-solid'); }
    else { starBtn.classList.remove('starred'); starIcon.classList.remove('fa-solid'); starIcon.classList.add('fa-regular'); }
  }

  questionSlider.addEventListener('input', function() {
    const displayed = getDisplayedQuestions();
    const newIndex = parseInt(this.value) - 1;
    if (displayed.length > 0 && newIndex >= 0 && newIndex < displayed.length && newIndex !== currentQuestionIndex) {
      currentQuestionIndex = newIndex;
      showQuestion();
      updateProgressAndSlider();
      updateStarButton();
    }
  });

  starBtn.addEventListener('click', function() {
    const displayedQuestions = getDisplayedQuestions();
    if (displayedQuestions.length === 0) return;
    const question = displayedQuestions[currentQuestionIndex];
    const questionId = question.id;
    const index = starredQuestions.indexOf(questionId);
    const starIcon = this.querySelector('i');
    if (index === -1) {
      starredQuestions.push(questionId);
      this.classList.add('starred');
      starIcon.classList.remove('fa-regular');
      starIcon.classList.add('fa-solid');
    } else {
      starredQuestions.splice(index, 1);
      this.classList.remove('starred');
      starIcon.classList.remove('fa-solid');
      starIcon.classList.add('fa-regular');
    }
    saveStarredQuestions(currentSubject);
    if (showOnlyStarred) {
      const displayed = getDisplayedQuestions();
      if (displayed.length === 0) {
        questionText.innerHTML = '<p>لا توجد أسئلة مميزة بعد.</p>';
        optionsContainer.innerHTML = '';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        currentQ.textContent = 0;
        totalQs.textContent = 0;
        questionSlider.max = 1;
        questionSlider.value = currentQuestions.length;
        updateProgressAndSlider();
      } else {
        if (currentQuestionIndex >= displayed.length) currentQuestionIndex = displayed.length - 1;
        showQuestion();
        updateNavigationButtons();
        updateProgressAndSlider();
      }
    }
  });

  /* --- زر وضع الدراسة (الصحين) --- */
  function setStudyToggleUI(on) {
    if (on) {
      studyToggle.classList.add('on');
      studyToggle.title = 'وضع الدراسة مفعل — الإجابات الصحيحة ظاهرة والتنقّل متاح فقط';
      studyToggle.innerHTML = '<i class="fa-solid fa-check-double"></i>';
    } else {
      studyToggle.classList.remove('on');
      studyToggle.title = 'وضع الدراسة معطل — يمكنك اختيار الإجابات كما في الوضع العادي';
      studyToggle.innerHTML = '<i class="fa-solid fa-check-double"></i>';
    }
  }

  studyToggle.addEventListener('click', function() {
    studyMode = !studyMode;
    setStudyToggleUI(studyMode);
    // عند التبديل، أظهر السؤال الحالي مع مراعاة وضع الدراسة
    showQuestion();
  });

  /* --- عرض السؤال --- */
  function showQuestion() {
    const displayedQuestions = getDisplayedQuestions();
    if (displayedQuestions.length === 0) {
      questionText.innerHTML = '<p>لا توجد أسئلة لعرضها.</p>';
      optionsContainer.innerHTML = '';
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      currentQ.textContent = 0;
      totalQs.textContent = 0;
      questionSlider.max = 1;
      questionSlider.value = currentQuestions.length;
      updateProgressAndSlider();
      questionContainer.classList.remove('correct','incorrect');
      return;
    }
    const question = displayedQuestions[currentQuestionIndex];
    questionText.textContent = question.text;
    optionsContainer.innerHTML = '';
    const originalIndex = currentQuestions.findIndex(q => q.id === question.id);
    let isAnswered = userAnswers[originalIndex] !== null;

    // إذا كنا في وضع الدراسة، نمنع اختيار الإجابات ونعرض الإجابة الصحيحة
    const correctIdx = question.correctAnswer - 1;

    // إظهار الخيارات
    question.options.forEach((option, index) => {
      const optionElement = document.createElement('div');
      optionElement.className = 'option';
      optionElement.textContent = option;

      // إذا وضع الدراسة مفعل: عرض الإجابة الصحيحة وتعطيل النقر
      if (studyMode) {
        optionElement.style.pointerEvents = 'none';
        optionElement.title = 'وضع الدراسة مفعل — معطل للاختيار';
        if (index === correctIdx) optionElement.classList.add('correct');
      } else {
        // سلوك الوضع العادي كما كان: تلوين استجابة المستخدم/الصحيحة إن وُجدت
        if (isAnswered) {
          const userSelectedIdx = userAnswers[originalIndex] - 1;
          if (index === correctIdx && userSelectedIdx !== correctIdx) optionElement.classList.add('correct');
          if (userSelectedIdx === index) {
            if (userSelectedIdx === correctIdx) optionElement.classList.add('correct');
            else optionElement.classList.add('incorrect');
          }
        }
        optionElement.addEventListener('click', () => selectOption(index + 1, question.id));
      }
      optionsContainer.appendChild(optionElement);
    });

    // إضافة متسع إذا لزم
    for (let i = question.options.length; i < 5; i++) {
      let filler = document.createElement('div');
      filler.className = 'option';
      filler.style.visibility = 'hidden';
      filler.innerHTML = '&nbsp;';
      optionsContainer.appendChild(filler);
    }

    // شرح السؤال
    const infoBtn = document.getElementById('info-btn');
    const explanationDiv = document.getElementById('question-explanation');
    if (question.explanation) {
      infoBtn.style.display = 'inline-block';
      infoBtn.onclick = () => {
        explanationDiv.style.display = (explanationDiv.style.display === 'none') ? 'block' : 'none';
        explanationDiv.textContent = question.explanation;
      };
    } else {
      infoBtn.style.display = 'none';
      explanationDiv.style.display = 'none';
    }

    // زر إظهار الإجابة الصحيحة (موجود سابقا) — يعمل كذلك لكن في وضع الدراسة كل شيء ظاهر بالفعل
    const showAnswerBtn = document.getElementById('show-answer-btn');
    if (showAnswerBtn) {
      showAnswerBtn.onclick = () => {
        const options = optionsContainer.querySelectorAll('.option');
        options.forEach((opt, idx) => { if (idx === correctIdx) opt.classList.add('correct'); });
      };
    }

    // تحديث العدادات والسلايدر
    currentQ.textContent = currentQuestionIndex + 1;
    totalQs.textContent = displayedQuestions.length;
    questionSlider.max = displayedQuestions.length;
    questionSlider.value = currentQuestionIndex + 1;
    updateNavigationButtons();
    updateStarButton();
    updateProgressAndSlider();
  }

  function selectOption(optionIndex, questionId) {
    if (studyMode) return; // يمنع الاختيار لو وضع الدراسة مفعل
    document.getElementById('question-explanation').style.display = 'none';
    const originalIndex = currentQuestions.findIndex(q => q.id === questionId);
    if (userAnswers[originalIndex] !== null) return;
    playClick();
    userAnswers[originalIndex] = optionIndex;
    const displayedQuestions = getDisplayedQuestions();
    const question = displayedQuestions[currentQuestionIndex];
    const correctIdx = question.correctAnswer - 1;
    const options = optionsContainer.querySelectorAll('.option');
    let isCorrect = optionIndex === question.correctAnswer;
    let isIncorrect = !isCorrect;
    questionContainer.classList.remove('correct','incorrect');

    options.forEach((opt, idx) => {
      if (optionIndex - 1 === idx) {
        if (isCorrect) opt.classList.add('correct');
        else { opt.classList.add('incorrect'); opt.classList.add('shake'); setTimeout(() => opt.classList.remove('shake'), 500); }
      }
      if (isIncorrect && idx === correctIdx) opt.classList.add('correct');
    });

    if (isIncorrect) {
      options[optionIndex - 1].classList.add('shake');
      setTimeout(() => options[optionIndex - 1].classList.remove('shake'), 500);
      setTimeout(() => {
        if (currentQuestionIndex < displayedQuestions.length - 1) {
          currentQuestionIndex++;
          showQuestion();
          updateProgressAndSlider();
        }
      }, 1500);
    } else {
      setTimeout(() => {
        if (currentQuestionIndex < displayedQuestions.length - 1) {
          currentQuestionIndex++;
          showQuestion();
          updateProgressAndSlider();
        } else {
          showResults();
        }
      }, 900);
    }
    updateNavigationButtons();
  }

  function updateNavigationButtons() {
    const displayed = getDisplayedQuestions();
    prevBtn.disabled = currentQuestionIndex === 0 || displayed.length === 0;
    nextBtn.disabled = displayed.length === 0;
    if (currentQuestionIndex === displayed.length - 1) nextBtn.textContent = 'إنهاء الاختبار'; else nextBtn.textContent = 'التالي';
  }

  prevBtn.addEventListener('click', function() {
    document.getElementById('question-explanation').style.display = 'none';
    const displayed = getDisplayedQuestions();
    if (currentQuestionIndex > 0 && displayed.length > 0) {
      currentQuestionIndex--;
      showQuestion();
      updateProgressAndSlider();
      updateNavigationButtons();
    }
  });

  nextBtn.addEventListener('click', function() {
    document.getElementById('question-explanation').style.display = 'none';
    const displayed = getDisplayedQuestions();
    if (currentQuestionIndex < displayed.length - 1) {
      currentQuestionIndex++;
      showQuestion();
      updateProgressAndSlider();
      updateNavigationButtons();
    } else {
      showResults();
    }
  });

  function updateProgressAndSlider() {
    const displayedQuestions = getDisplayedQuestions();
    let percent = 0;
    if (displayedQuestions.length > 0) percent = 100 - ((currentQuestionIndex + 1) / displayedQuestions.length) * 100;
    questionSlider.max = displayedQuestions.length;
    questionSlider.value = currentQuestionIndex + 1;
    maxQuestionLabel.textContent = displayedQuestions.length;
  }

  function showResults() {
    let correct = 0;
    for (let i = 0; i < currentQuestions.length; i++) {
      if (userAnswers[i] === currentQuestions[i].correctAnswer) correct++;
    }
    scoreElement.textContent = `${correct}/${currentQuestions.length}`;
    examSection.style.display = 'none';
    resultsSection.style.display = 'block';
  }

  restartBtn.addEventListener('click', function() {
    subjectSection.style.display = 'block';
    examSection.style.display = 'none';
    resultsSection.style.display = 'none';
  });
  bottomBackBtn.addEventListener('click', function() {
    subjectSection.style.display = 'block';
    examSection.style.display = 'none';
    resultsSection.style.display = 'none';
  });
  resultsBackBtn.addEventListener('click', function() {
    subjectSection.style.display = 'block';
    examSection.style.display = 'none';
    resultsSection.style.display = 'none';
  });

  function playClick() { if (clickAudio) { clickAudio.currentTime = 0; clickAudio.play(); } }

  // تهيئة زر وضع الدراسة UI في البداية
  setStudyToggleUI(false);

});
</script>
</body>
</html>
