<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>WAY</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<style>
body {
    font-size: 16px;
    background: #e0e0e0;
    color: #333;
    min-height: 100vh;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
}
.container {
    width: 100%;
    max-width: 900px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    overflow: hidden;
    margin: 20px 0;
    position: relative;
}
header {
    background: #2e7d52;
    color: white;
    padding: 18px 10px 18px 10px;
    text-align: center;
}
h1 { font-size: 27px; margin-bottom: 3px; font-weight: bold;}
.progress-slider-bar {
    width: 100%;
    margin: 15px 0 10px 0;
    padding: 0 7px;
    display: flex;
    align-items: center;
    gap: 8px;
    position: relative;
    flex-direction: row;
}
.slider-labels { width: 28px; text-align: center; color: #2e7d52; font-weight: bold; }
.slider {
    width: 100%;
    -webkit-appearance: none;
    appearance: none;
    height: 10px;
    background: #e0e0e0;
    border-radius: 7px;
    outline: none;
    position: relative;
    z-index: 1;
    direction: rtl;
}
.slider::-webkit-slider-runnable-track {
    height: 10px;
    background: linear-gradient(
        to left,
        #2e7d52 0,
        #2e7d52 var(--progress-thumb,0%),
        #e0e0e0 var(--progress-thumb,0%),
        #e0e0e0 100%
    );
    border-radius: 7px;
}
.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #2e7d52;
    border: 2px solid #fff;
    cursor: pointer;
    box-shadow: 0 2px 8px #aaa;
    margin-top: -6px;
    transition: background 0.2s;
    z-index: 2;
    position: relative;
}
.slider:focus { outline: none; }
.slider::-moz-range-thumb {
    width: 22px; height: 22px;
    border-radius: 50%; background: #2e7d52; cursor: pointer; border: 2px solid #fff;
    box-shadow: 0 2px 8px #aaa;
    transition: background 0.2s;
}
.slider::-moz-range-track {
    height: 10px;
    background: linear-gradient(
        to left,
        #2e7d52 0,
        #2e7d52 var(--progress-thumb,0%),
        #e0e0e0 var(--progress-thumb,0%),
        #e0e0e0 100%
    );
    border-radius: 7px;
}
.slider::-ms-fill-lower {
    background: #2e7d52;
    border-radius: 7px;
}
.slider::-ms-fill-upper {
    background: #e0e0e0;
    border-radius: 7px;
}
.slider:focus::-webkit-slider-thumb { outline: none; }
.slider::-moz-range-progress {
    background-color: #2e7d52;
    height: 10px;
    border-radius: 7px;
}
.slider::-ms-fill-lower { background-color: #2e7d52; }
.slider::-ms-fill-upper { background-color: #e0e0e0; }
.slider-labels.left, .slider-labels.right { font-size: 13px; }
.slider:focus { outline: none; box-shadow: none; }
.subject-selection { padding: 15px; text-align: center;}
.selection-container {
    display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin: 10px 0;
}
select {
    padding: 8px 12px; border-radius: 7px; border: 2px solid #2e7d52;
    font-size: 14px; width: 100%; max-width: 230px;
}
.start-btn {
    padding: 9px 20px; background: #2e7d52; color: white; border: none;
    border-radius: 7px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s;
    margin-top: 12px;
}
.start-btn:hover {
    background: #1e5e3b; transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
.exam-section { padding: 12px; display: none;}
.subject-name {
    text-align: center; font-size: 17px; font-weight: bold; color: #2e7d52;
    margin-bottom: 13px; padding: 7px; background: #e8f5e9; border-radius: 7px;
}
.progress-text { text-align: center; font-weight: bold; color: #2e7d52; margin-bottom: 7px; font-size: 13px;}
.question-container {
    margin-bottom: 18px; padding: 13px 12px 12px 12px; border: 2px solid #ddd;
    border-radius: 8px; background: #f9f9f9; position: relative; min-height: 110px;
    display: flex; flex-direction: column; align-items: stretch;
    transition: border-color 0.3s;
    padding-bottom: 50px;
}
.question-header-bar {
    display: flex; align-items: center; gap: 9px; margin-bottom: 7px; width:100%;
}
.star-btn {
    background: none; border: none;
    font-size: 23px; color: #ccc; cursor: pointer; transition: all 0.3s;
    margin: 0 0 0 8px; padding:0;
    order: 2;
}
.star-btn .fa-star {
    text-shadow: 0 2px 5px #ffc10777, 0 1px 2px #fff;
}
.star-btn.starred,
.star-btn.starred .fa-star{
    color: #ffc107 !important;
    text-shadow: 0 2px 5px #c6efd9, 0 1px 2px #fff,0 0 8px #ffc107cc;
}
.star-btn:hover { color: #ffc107;}
.info-btn {
    background: none; border: none; font-size: 20px; color: #2e7d52; cursor: pointer;
    margin-right: auto; margin-left: 5px;
}
.info-btn:hover { color: #1e5e3b;}
.question-explanation {
    margin-top: 35px;
    background: #eef7f1; padding: 10px; border-radius: 7px; margin-top: 7px;
    border-right: 4px solid #2e7d52; font-size: 13px; line-height: 1.5; color:#333;
    margin-top: 10px !important;
    clear: both;
}
.question-text {
    font-size: 18px;
    font-size: 15px; color: #2c3e50; font-weight: 500;
    line-height: 1.5; order: 1; flex: 1; padding: 0; margin: 0;
    word-break: break-word;
}
.options-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-height: 120px;
    margin-bottom: 5px;
}
.option {
    font-size: 14px;
    padding: 9px;
    background: #f8f8f8;
    border: 2px solid #e0e0e0;
    border-radius: 7px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
}
.option:hover { border-color: #2e7d52; background: #f0f8f1;}
.correct {
    border-color: #4caf50 !important;
    border-width: 4px !important;
    color: #2c3e50;
    background: #f9f9f9 !important;
}
.incorrect {
    border-color: #f44336 !important;
    border-width: 4px !important;
    color: #2c3e50;
    background: #f9f9f9 !important;
}
.navigation-bar-fixed-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 7px;
    background: #fff;
    z-index: 30;
    padding: 7px 0 7px 0;
    margin: 0 -12px 10px -12px;
    border-bottom: 1px solid #e0e0e0;
    flex-direction: row;
}
.nav-btn {
    padding: 5px 13px;
    background: #2e7d52;
    color: white;
    border: none;
    border-radius: 7px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s;
    min-width: 54px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.nav-btn:disabled { background: #cccccc; cursor: not-allowed;}
.nav-btn:hover:not(:disabled) {
    background: #1e5e3b; transform: translateY(-2px);
}
.nav-btn i {
    font-size: 1.3em;
    vertical-align: middle;
}
.show-featured-btn {
    padding: 0;
    background: none;
    border: none;
    border-radius: 50%;
    font-size: 23px;
    cursor: pointer;
    min-width: 0;
    min-height: 0;
    width: 38px;
    height: 38px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: none;
}
.show-featured-btn i {
    font-size: 23px;
    transition: color 0.2s;
    color: silver;
}
.show-featured-btn.active i {
    color: #ffd700;
}
.show-featured-btn:focus {
    outline: none;
}
.solve-mode-btn {
    background: none;
    border: none;
    font-size: 1.4rem;
    cursor: pointer;
    padding: 2px 8px;
    color: silver;
    transition: color 0.2s;
}
.solve-mode-btn.active {
    color: #4caf50;
}
.solve-mode-btn:hover {
    background: #f1f1f1;
    border-radius: 50%;
}
.home-btn {
    background: none;
    border: none;
    font-size: 1.6rem;
    cursor: pointer;
    padding: 2px 8px;
    color: #2e7d52;
    transition: background 0.2s;
    line-height: 1;
}
.home-btn:hover {
    background: #e3f2fd;
    border-radius: 50%;
}
.results-section { padding: 25px; text-align: center; display: none;}
.results-section h2 { color: #2e7d52; margin-bottom: 15px;}
.score {
    font-size: 36px; font-weight: bold; color: #2e7d52; margin: 16px 0;
}
.restart-btn {
    padding: 10px 30px; background: #2e7d52; color: white; border: none;
    border-radius: 7px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s;
    margin-top: 22px;
}
.restart-btn:hover {
    background: #1e5e3b; transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
.shake { animation: shake 0.5s;}
@keyframes shake {
    0% { transform: translateX(0);}
    20% { transform: translateX(-10px);}
    40% { transform: translateX(10px);}
    60% { transform: translateX(-10px);}
    80% { transform: translateX(10px);}
    100% { transform: translateX(0);}
}
.column10-info {
    background: #e8f5e9; padding: 13px; border-radius: 7px; margin: 11px 0;
    border-right: 5px solid #2e7d52; font-size: 13px; line-height: 1.6;
}
.bottom-back-btn {
    padding: 8px 16px; background: #2e7d52; color: white; border: none; border-radius: 8px;
    cursor: pointer; font-size: 13px; transition: all 0.3s;
    margin: 14px auto; display: block;
}
.bottom-back-btn:hover {
    background: #1e5e3b; transform: translateY(-2px);
}
.loading {
    text-align: center; padding: 20px; font-size: 15px; color: #2e7d52;
}
#info-btn {
    position: absolute;
    bottom: 8px;
    left: 12px;
}
#question-container { position: relative; }
#show-answer-btn {
    position: absolute;
    bottom: 8px;
    right: 12px;
    font-size: 20px;
    color: #2e7d52;
    background: none;
    border: none;
    cursor: pointer;
}
#show-answer-btn:hover {
    color: #1e5e3b;
}
</style>
</head>
<body>
<audio id="click-audio" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12bfa6f1e1.mp3"></audio>
<div class="container">
<header>
<h1>WAY</h1>
</header>
<div class="loading" id="loading">
<i class="fas fa-spinner fa-spin"></i> جاري تحميل بيانات الاختبار...
</div>
<div class="subject-selection" id="subject-section" style="display: none;">
<h2>اختر المادة:</h2>
<div class="selection-container">
<select id="subject-select"></select>
<select id="column10-info"></select>
<select id="column11-select" style="display:none"></select>
</div>
<button class="start-btn" id="start-btn">بدء الاختبار</button>
</div>
<div class="exam-section" id="exam-section">
<div class="subject-name" id="subject-name"></div>
<div class="progress-text">السؤال <span id="current-q">1</span> من <span id="total-qs">0</span></div>
<div class="progress-slider-bar">
<div class="slider-labels left"><span>1</span></div>
<input class="slider" id="question-slider" max="10" min="1" type="range" value="10"/>
<div class="slider-labels right"><span id="max-question">10</span></div>
</div>
<div class="navigation-bar-fixed-top" id="nav-top-bar">
    <button class="nav-btn" disabled="" id="prev-btn" title="السابق">
        <i class="fa-solid fa-arrow-right"></i>
    </button>
    <button class="show-featured-btn" id="show-featured-btn" title="عرض المميزة"><i class="fa-solid fa-star"></i></button>
    <button class="solve-mode-btn" id="solve-mode-btn" title="إظهار الحلول"><i class="fa-solid fa-check-double"></i></button>
    <button class="home-btn" id="nav-home-btn" title="الصفحة الرئيسية"><i class="fas fa-home"></i></button>
    <button class="nav-btn" id="next-btn" title="التالي">
        <i class="fa-solid fa-arrow-left"></i>
    </button>
</div>
<div class="question-container" id="question-container">
<div class="question-header-bar">
<button class="star-btn" id="star-btn" title="تمييز السؤال">
<i class="fa-regular fa-star"></i>
</button>
<div class="question-text" id="question-text"></div>
</div>
<div class="options-container" id="options-container"></div>
<div class="question-explanation" id="question-explanation" style="display:none;"></div>
<button class="info-btn" id="info-btn" title="عرض الشرح"><i class="fa-solid fa-circle-info"></i></button>
<button class="info-btn" id="show-answer-btn" title="إظهار الإجابة الصحيحة"><i class="fa-solid fa-check"></i></button>
</div>
<button class="bottom-back-btn" id="bottom-back-btn" style="display:none">
<i class="fas fa-home"></i> العودة للبداية
</button>
</div>
<div class="results-section" id="results-section">
<h2>لقد أكملت الاختبار!</h2>
<p>درجتك النهائية هي:</p>
<div class="score" id="score">0/0</div>
<button class="restart-btn" id="restart-btn">إعادة الاختبار</button>
<button class="bottom-back-btn" id="results-back-btn">
<i class="fas fa-home"></i> العودة للبداية
</button>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... جميع المتغيرات والإعدادات كما هي ...
    const loadingElement = document.getElementById('loading');
    const subjectSection = document.getElementById('subject-section');
    const subjectSelect = document.getElementById('subject-select');
    const column10Info = document.getElementById('column10-info');
    const startBtn = document.getElementById('start-btn');
    const examSection = document.getElementById('exam-section');
    const subjectNameElement = document.getElementById('subject-name');
    const resultsSection = document.getElementById('results-section');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const currentQ = document.getElementById('current-q');
    const totalQs = document.getElementById('total-qs');
    const scoreElement = document.getElementById('score');
    const restartBtn = document.getElementById('restart-btn');
    const bottomBackBtn = document.getElementById('bottom-back-btn');
    const resultsBackBtn = document.getElementById('results-back-btn');
    const questionSlider = document.getElementById('question-slider');
    const maxQuestionLabel = document.getElementById('max-question');
    const starBtn = document.getElementById('star-btn');
    const showFeaturedBtn = document.getElementById('show-featured-btn');
    const navHomeBtn = document.getElementById('nav-home-btn');
    const questionContainer = document.getElementById('question-container');
    const clickAudio = document.getElementById('click-audio');
    let solveMode = false;
    const solveModeBtn = document.getElementById('solve-mode-btn');
    solveModeBtn.addEventListener('click', function() {
        solveMode = !solveMode;
        this.classList.toggle('active', solveMode);
        showQuestion();
    });

    // بيانات التطبيق
    let questionsData = [];
    let currentSubject = '';
    let currentQuestions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let starredQuestions = [];
    let subjectColumn10 = {};
    let subjectColumn11 = {};
    let showOnlyStarred = false;
    const excelFileURL = "https://webdr-creator.github.io/Excel/MCQ2.xlsx";

    function getStarStorageKey(subject) {
        return `starredQuestions_${subject}`;
    }
    function loadStarredQuestions(subject) {
        try {
            const saved = localStorage.getItem(getStarStorageKey(subject));
            if (saved) {
                starredQuestions = JSON.parse(saved);
            } else {
                starredQuestions = [];
            }
        } catch (e) {
            starredQuestions = [];
        }
    }
    function saveStarredQuestions(subject) {
        localStorage.setItem(getStarStorageKey(subject), JSON.stringify(starredQuestions));
    }

    loadExcelFile(excelFileURL);
    function loadExcelFile(url) {
        loadingElement.style.display = 'block';
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('حدث خطأ في تحميل الملف');
                return response.arrayBuffer();
            })
            .then(data => {
                processExcelData(data);
                loadingElement.style.display = 'none';
                subjectSection.style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                loadingElement.innerHTML = '<p style="color: red;">فشل في تحميل ملف Excel. يرجى التحقق من الاتصال بالإنترنت.</p>';
            });
    }
    function processExcelData(data) {
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        questionsData = [];
        const subjects = new Set();
        subjectColumn10 = {};
        const startRow = jsonData[0].length > 0 && isNaN(jsonData[0][0]) ? 1 : 0;
        for (let i = startRow; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (!row || row.length < 7) continue;
            const question = {
                explanation: row[7] || '',
                text: row[0] || 'بدون نص',
                options: [],
                correctAnswer: parseInt(row[6]) || 1,
                subject: row[8] || 'عام',
                id: i,
                col10: row[9] || '',
                col11: row[10] || ''
            };
            for (let j = 1; j <= 5; j++) {
                if (row[j]) question.options.push(row[j]);
            }
            if (question.options.length === 0) {
                question.options.push('نعم');
                question.options.push('لا');
            }
            questionsData.push(question);
            subjects.add(question.subject);
            if (row[9] && !subjectColumn10[question.subject]) {
                subjectColumn10[question.subject] = row[9];
            }
        }
        subjectSelect.innerHTML = '';
        subjects.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject;
            option.textContent = subject;
            subjectSelect.appendChild(option);
        });
        currentSubject = subjectSelect.value;
        updateColumn10Info();
        loadStarredQuestions(currentSubject);
    }
    
function updateColumn10Info() {
        column10Info.innerHTML = '';
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "اختر فصل";
        placeholder.disabled = true;
        placeholder.selected = true;
        column10Info.appendChild(placeholder);

        let col10Set = new Set();
        questionsData.forEach(q => {
            if (q.subject === currentSubject && q.col10) col10Set.add(q.col10);
        });

        if (col10Set.size === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'لا توجد معلومات إضافية';
            opt.disabled = true;
            column10Info.appendChild(opt);
        } else {
            col10Set.forEach(val => {
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                column10Info.appendChild(opt);
            });
        }

        const column11Select = document.getElementById('column11-select');
        column11Select.innerHTML = '';
        column11Select.style.display = 'none';

        column10Info.onchange = function() {
            column11Select.innerHTML = '';
            let col11Set2 = new Set();
            questionsData.forEach(q => {
                if (q.subject === currentSubject && q.col10 === this.value && q.col11) col11Set2.add(q.col11);
            });
            if (col11Set2.size > 0) {
                column11Select.style.display = 'inline-block';
                const allOpt = document.createElement('option');
                allOpt.value = 'الكل';
                allOpt.textContent = 'الكل';
                column11Select.appendChild(allOpt);
                col11Set2.forEach(val => {
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.textContent = val;
                    column11Select.appendChild(opt);
                });
            } else {
                column11Select.style.display = 'none';
            }
        };
    }

    subjectSelect.addEventListener('change', function() {
        currentSubject = this.value;
        updateColumn10Info();
        loadStarredQuestions(currentSubject);
        if (examSection.style.display === 'block') updateStarButton();
    });
    
startBtn.addEventListener('click', function() {
    currentSubject = subjectSelect.value;
    let col10Val = document.getElementById('column10-info').value;
    let col11Val = document.getElementById('column11-select').value;

    if (!col10Val || col10Val === "") {
        showError("اختر فصل");
        return;
    }

    currentQuestions = questionsData.filter(q => q.subject === currentSubject);
    if (col10Val) currentQuestions = currentQuestions.filter(q => q.col10 === col10Val);
    if (col11Val && col11Val !== 'الكل') currentQuestions = currentQuestions.filter(q => q.col11 === col11Val);
    if (currentQuestions.length === 0) {
        showError("لا توجد أسئلة لهذه المادة");
        return;
    }

    userAnswers = new Array(currentQuestions.length).fill(null);
    loadStarredQuestions(currentSubject);
    currentQuestionIndex = 0;
    showOnlyStarred = false;
    showFeaturedBtn.classList.remove('active');
    totalQs.textContent = currentQuestions.length;
    subjectNameElement.textContent = currentSubject;
    maxQuestionLabel.textContent = currentQuestions.length;
    questionSlider.max = currentQuestions.length;
    questionSlider.value = currentQuestions.length;
    updateProgressAndSlider();
    updateStarButton();
    showQuestion();
    subjectSection.style.display = 'none';
    examSection.style.display = 'block';
});

function showError(msg) {
    const notification = document.createElement("div");
    notification.textContent = msg;
    notification.style.position = "fixed";
    notification.style.top = "20px";
    notification.style.right = "20px";
    notification.style.background = "#f44336";
    notification.style.color = "white";
    notification.style.padding = "10px 15px";
    notification.style.borderRadius = "6px";
    notification.style.boxShadow = "0 2px 8px rgba(0,0,0,0.3)";
    notification.style.zIndex = "9999";
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}
function getDisplayedQuestions() {
        if (showOnlyStarred) {
            return currentQuestions.filter(q => starredQuestions.includes(q.id));
        }
        return currentQuestions;
    }
    showFeaturedBtn.addEventListener('click', function() {
        showOnlyStarred = !showOnlyStarred;
        this.classList.toggle('active', showOnlyStarred);
        const displayed = getDisplayedQuestions();
        if (displayed.length === 0) {
            questionText.innerHTML = '<p>لا توجد أسئلة مميزة بعد.</p>';
            optionsContainer.innerHTML = '';
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            currentQ.textContent = 0;
            totalQs.textContent = 0;
            questionSlider.max = 1;
            questionSlider.value = currentQuestions.length;
            updateProgressAndSlider();
        } else {
            currentQuestionIndex = 0;
            showQuestion();
            updateProgressAndSlider();
            updateNavigationButtons();
        }
    });

    navHomeBtn.addEventListener('click', function() {
        subjectSection.style.display = 'block';
        examSection.style.display = 'none';
        resultsSection.style.display = 'none';
    });

    function updateStarButton() {
        const displayedQuestions = getDisplayedQuestions();
        if (displayedQuestions.length === 0) return;
        const question = displayedQuestions[currentQuestionIndex];
        const isStarred = starredQuestions.includes(question.id);
        const starIcon = starBtn.querySelector('i');
        if (isStarred) {
            starBtn.classList.add('starred');
            starIcon.classList.remove('fa-regular');
            starIcon.classList.add('fa-solid');
        } else {
            starBtn.classList.remove('starred');
            starIcon.classList.remove('fa-solid');
            starIcon.classList.add('fa-regular');
        }
    }
    questionSlider.addEventListener('input', function() {
        const displayed = getDisplayedQuestions();
        const newIndex = parseInt(this.value) - 1;
        if (displayed.length > 0 && newIndex >= 0 && newIndex < displayed.length && newIndex !== currentQuestionIndex) {
            currentQuestionIndex = newIndex;
            showQuestion();
            updateProgressAndSlider();
            updateStarButton();
        }
    });
    starBtn.addEventListener('click', function() {
        const displayedQuestions = getDisplayedQuestions();
        if (displayedQuestions.length === 0) return;
        const question = displayedQuestions[currentQuestionIndex];
        const questionId = question.id;
        const index = starredQuestions.indexOf(questionId);
        const starIcon = this.querySelector('i');
        if (index === -1) {
            starredQuestions.push(questionId);
            this.classList.add('starred');
            starIcon.classList.remove('fa-regular');
            starIcon.classList.add('fa-solid');
        } else {
            starredQuestions.splice(index, 1);
            this.classList.remove('starred');
            starIcon.classList.remove('fa-solid');
            starIcon.classList.add('fa-regular');
        }
        saveStarredQuestions(currentSubject);
        if (showOnlyStarred) {
            const displayed = getDisplayedQuestions();
            if (displayed.length === 0) {
                questionText.innerHTML = '<p>لا توجد أسئلة مميزة بعد.</p>';
                optionsContainer.innerHTML = '';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                currentQ.textContent = 0;
                totalQs.textContent = 0;
                questionSlider.max = 1;
                questionSlider.value = currentQuestions.length;
                updateProgressAndSlider();
            } else {
                if (currentQuestionIndex >= displayed.length) {
                    currentQuestionIndex = displayed.length - 1;
                }
                showQuestion();
                updateNavigationButtons();
                updateProgressAndSlider();
            }
        }
    });

    function showQuestion() {
        const displayedQuestions = getDisplayedQuestions();
        if (displayedQuestions.length === 0) {
            questionText.innerHTML = '<p>لا توجد أسئلة لعرضها.</p>';
            optionsContainer.innerHTML = '';
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            currentQ.textContent = 0;
            totalQs.textContent = 0;
            questionSlider.max = 1;
            questionSlider.value = currentQuestions.length;
            updateProgressAndSlider();
            questionContainer.classList.remove('correct','incorrect');
            return;
        }
        const question = displayedQuestions[currentQuestionIndex];
        questionText.textContent = question.text;
        optionsContainer.innerHTML = '';
        const originalIndex = currentQuestions.findIndex(q => q.id === question.id);
        let isAnswered = userAnswers[originalIndex] !== null;

        if (!solveMode && userAnswers[originalIndex] !== null) {
            userAnswers[originalIndex] = null;
        }

        questionContainer.classList.remove('correct','incorrect');

        let correctIdx = question.correctAnswer - 1;
        let userSelectedIdx = isAnswered ? userAnswers[originalIndex] - 1 : -1;
        question.options.forEach((option, index) => {
            const optionElement = document.createElement('div');
            optionElement.className = 'option';
            optionElement.textContent = option;
            if (isAnswered) {
                if (index === correctIdx) {
                    if (userSelectedIdx !== correctIdx) {
                        optionElement.classList.add('correct');
                    }
                }
                if (userSelectedIdx === index) {
                    if (userSelectedIdx === correctIdx) {
                        optionElement.classList.add('correct');
                    } else {
                        optionElement.classList.add('incorrect');
                    }
                }
            }
            optionElement.addEventListener('click', () => selectOption(index + 1, question.id));
            if (solveMode && index === correctIdx) {
                optionElement.classList.add('correct');
            }
            optionsContainer.appendChild(optionElement);
        });
        for (let i = question.options.length; i < 5; i++) {
            let filler = document.createElement('div');
            filler.className = 'option';
            filler.style.visibility = 'hidden';
            filler.innerHTML = '&nbsp;';
            optionsContainer.appendChild(filler);
        }
        const infoBtn = document.getElementById('info-btn');
        const explanationDiv = document.getElementById('question-explanation');
        if (question.explanation) {
            infoBtn.style.display = 'inline-block';
            infoBtn.onclick = () => {
                explanationDiv.style.display = (explanationDiv.style.display === 'none') ? 'block' : 'none';
                explanationDiv.textContent = question.explanation;
            };
        } else {
            infoBtn.style.display = 'none';
            explanationDiv.style.display = 'none';
        }

        const showAnswerBtn = document.getElementById('show-answer-btn');
        if (showAnswerBtn) {
            showAnswerBtn.onclick = () => {
                const options = optionsContainer.querySelectorAll('.option');
                options.forEach((opt, idx) => {
                    if (idx === correctIdx) {
                        opt.classList.add('correct');
                    }
                });
            };
        }

        currentQ.textContent = currentQuestionIndex + 1;
        totalQs.textContent = displayedQuestions.length;

        questionSlider.max = displayedQuestions.length;
        questionSlider.value = currentQuestionIndex + 1;
        updateNavigationButtons();
        updateStarButton();
        updateProgressAndSlider();
    }

    function selectOption(optionIndex, questionId) {
        document.getElementById('question-explanation').style.display = 'none';
        const originalIndex = currentQuestions.findIndex(q => q.id === questionId);
        if (userAnswers[originalIndex] !== null) return;
        playClick();
        userAnswers[originalIndex] = optionIndex;
        const displayedQuestions = getDisplayedQuestions();
        const question = displayedQuestions[currentQuestionIndex];
        const correctIdx = question.correctAnswer - 1;
        const options = optionsContainer.querySelectorAll('.option');
        let isCorrect = optionIndex === question.correctAnswer;
        let isIncorrect = !isCorrect;
        questionContainer.classList.remove('correct','incorrect');

        options.forEach((opt, idx) => {
            if (optionIndex - 1 === idx) {
                if (isCorrect) {
                    opt.classList.add('correct');
                } else {
                    opt.classList.add('incorrect');
                    opt.classList.add('shake');
                    setTimeout(() => opt.classList.remove('shake'), 500);
                }
            }
            if (isIncorrect && idx === correctIdx) {
                opt.classList.add('correct');
            }
        });

        if (isIncorrect) {
            options[optionIndex - 1].classList.add('shake');
            setTimeout(() => options[optionIndex - 1].classList.remove('shake'), 500);
            setTimeout(() => {
                if (currentQuestionIndex < displayedQuestions.length - 1) {
                    currentQuestionIndex++;
                    showQuestion();
                    updateProgressAndSlider();
                }
            }, 1500);
        } else {
            setTimeout(() => {
                if (currentQuestionIndex < displayedQuestions.length - 1) {
                    currentQuestionIndex++;
                    showQuestion();
                    updateProgressAndSlider();
                } else {
                    showResults();
                }
            }, 900);
        }
        updateNavigationButtons();
    }

    function updateNavigationButtons() {
        const displayed = getDisplayedQuestions();
        prevBtn.disabled = currentQuestionIndex === 0 || displayed.length === 0;
        nextBtn.disabled = displayed.length === 0;
        if (currentQuestionIndex === displayed.length - 1) {
            nextBtn.innerHTML = '<i class="fa-solid fa-arrow-left"></i>';
            nextBtn.title = 'إنهاء الاختبار';
        } else {
            nextBtn.innerHTML = '<i class="fa-solid fa-arrow-left"></i>';
            nextBtn.title = 'التالي';
        }
        prevBtn.innerHTML = '<i class="fa-solid fa-arrow-right"></i>';
        prevBtn.title = 'السابق';
    }
    prevBtn.addEventListener('click', function() {
        document.getElementById('question-explanation').style.display = 'none';
        const displayed = getDisplayedQuestions();
        if (currentQuestionIndex > 0 && displayed.length > 0) {
            currentQuestionIndex--;
            showQuestion();
            updateProgressAndSlider();
            updateNavigationButtons();
        }
    });
    nextBtn.addEventListener('click', function() {
        document.getElementById('question-explanation').style.display = 'none';
        const displayed = getDisplayedQuestions();
        if (currentQuestionIndex < displayed.length - 1) {
            currentQuestionIndex++;
            showQuestion();
            updateProgressAndSlider();
            updateNavigationButtons();
        } else {
            showResults();
        }
    });
    // مؤشر السحب - التصاق الدائرة بنهاية الخط الأخضر مع أي عدد أسئلة
    function updateProgressAndSlider() {
        const displayedQuestions = getDisplayedQuestions();
        let slider = document.querySelector('.slider');
        let min = Number(slider.min);
        let max = Number(slider.max);
        let value = Number(slider.value);

        // موقع الدائرة كنسبة (0 في البداية، 1 في النهاية)
        let position = (value - min) / (max - min);

        // حساب العرض بدقة
        const sliderWidth = slider.offsetWidth;
        const thumbWidth = 22; // كما في CSS
        const halfThumbPercent = (thumbWidth / 2) / sliderWidth * 100;

        // النسبة التي تجعل الخط الأخضر ينتهي عند منتصف الدائرة دائماً
        let progressThumb = position * (100 - (thumbWidth / sliderWidth * 100)) + halfThumbPercent;

        // حماية من أي خطأ رياضي في الأطراف
        if (progressThumb < halfThumbPercent) progressThumb = halfThumbPercent;
        if (progressThumb > 100 - halfThumbPercent) progressThumb = 100 - halfThumbPercent;

        slider.style.setProperty('--progress-thumb', progressThumb + '%');
    }
    function showResults() {
        let score = 0;
        for (let i = 0; i < userAnswers.length; i++) {
            if (userAnswers[i] === null) continue;
            if (currentQuestions[i].correctAnswer === userAnswers[i]) score++;
        }
        scoreElement.textContent = score + " / " + userAnswers.length;
        examSection.style.display = 'none';
        resultsSection.style.display = 'block';
    }
    restartBtn.addEventListener('click', function() {
        subjectSection.style.display = 'block';
        examSection.style.display = 'none';
        resultsSection.style.display = 'none';
    });
    bottomBackBtn.addEventListener('click', function() {
        subjectSection.style.display = 'block';
        examSection.style.display = 'none';
        resultsSection.style.display = 'none';
    });
    resultsBackBtn.addEventListener('click', function() {
        subjectSection.style.display = 'block';
        examSection.style.display = 'none';
        resultsSection.style.display = 'none';
    });
    function playClick() {
        if (clickAudio) {
            clickAudio.currentTime = 0;
            clickAudio.play();
        }
    }
});
</script>
</body>
</html>
